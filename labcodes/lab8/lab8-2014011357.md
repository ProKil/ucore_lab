# Lab8 Report

计43 高童 2014011357

## 练习一：读文件操作

为了在`sfs_io_nolock()`函数中完成读/写文件的操作，总共需要三步。

第一步：拷贝文件最开头、没有和块对齐的部分。如果此时已经拷贝到文件尾，就直接退出。

```C
    blkoff = offset % SFS_BLKSIZE;
    if (blkoff != 0) {
        size = (nblks != 0) ? (SFS_BLKSIZE - blkoff) : (endpos - offset);
        if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0)
            goto out;
        if ((ret = sfs_buf_op(sfs, buf, size, ino, blkoff)) != 0)
            goto out;
        alen += size;
        if (nblks == 0) {
            goto out;
        }
        buf += size;
        blkno ++;
        nblks --;
    }
```

第二步：拷贝连续的块。具体实现采用`while`循环。

```C
    size = SFS_BLKSIZE;
    while (nblks > 0) {
        if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0)
            goto out;
        if ((ret = sfs_block_op(sfs, buf, ino, 1)) != 0)
            goto out;
        alen += size;
        buf += size;
        blkno ++;
        nblks --;
    }
```

第三步：拷贝文件最尾部、没有和块对齐的部分。

```C
    size = endpos % SFS_BLKSIZE;
    if (size != 0) {
        if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
            goto out;
        }
        if ((ret = sfs_buf_op(sfs, buf, size, ino, 0)) != 0) {
            goto out;
        }
        alen += size;
    }
```

每步实现过程大同小异。首先调用`sfs_bmap_load_nolock()`函数，获取目标块的`inode`编号，随后分别用`sfs_buf_op()`或者`sfs_block_op()`将数据内容拷贝到`buf`所在部分。最后，调整相关的变量。

**Unix的Pipe机制的概要设方案：**

在需要使用管道时，创建两个文件，并使这两个文件连接到同一个inode上。消息发送方将内容写入到发送文件，接收方从接收文件读取消息，即可完成通讯。

## 本实验知识点



## 本实验中未直接体现的知识点

